version: "3"

tasks:
  clean:
    desc: Removes UI's build directories
    cmds:
      - rm -rf build

  ci:
    - task: cloud_spec_viewer:ci

  #
  # docker namespace
  #
  docker:build:
    desc: Package site as a Docker container
    vars:
      TAG:
        sh: echo $(../../bin/clean-docker-tag {{.TAG}})
    cmds:
      - |
        docker build . \
          -t $DOCKER_REGISTRY/{{.REPO}}:{{.TAG}} \
          --build-arg APP={{.REPO}}

  docker:push:
    vars:
      TAG:
        sh: echo $(../../bin/clean-docker-tag $TAG)
    cmds:
      - docker push $DOCKER_REGISTRY/{{.REPO}}:{{.TAG}}
      - |
        if [[ "{{.TAG}}" =~ ^release-b ]]
        then
          echo "tagging and pushing 'latest'"
          docker tag $DOCKER_REGISTRY/{{.REPO}}:{{.TAG}} $DOCKER_REGISTRY/{{.REPO}}:latest
          docker push $DOCKER_REGISTRY/{{.REPO}}:latest
        fi

  #
  # cloud_spec_viewer namespace
  #
  cloud_spec_viewer:build:
    desc: Build cloud_spec_viewer site
    cmds:
      - task: :workspaces:build
      - >
        BUILD_PATH=build-cloud_spec_viewer
        REACT_APP_API_URL=https://api.useoptic.com
        yarn build:cloud
    sources:
      - src/**
      - package.json
      - '**.ts'
      - scripts/*spec*
    generates:
      - build-cloud_spec_viewer/**

  cloud_spec_viewer:docker:build:
    - task: cloud_spec_viewer:build
    - task: docker:build
      vars:
        REPO: cloud_spec_viewer

  cloud_spec_viewer:docker:push:
    vars:
      TAG:
        sh: echo $(../../bin/clean-docker-tag $TAG)
    cmds:
      - task: docker:push
        vars:
          REPO: cloud_spec_viewer
      - task: :docker:slack-notifier
        vars:
          TAG: "{{.TAG}}"
          REPO: cloud_spec_viewer

  cloud_spec_viewer:ci:
    desc: CI workflow
    deps: [":workspaces:setup"]
    cmds:
      - task: cloud_spec_viewer:docker:build
      - task: cloud_spec_viewer:docker:push
        vars:
          REPO: cloud_spec_viewer
