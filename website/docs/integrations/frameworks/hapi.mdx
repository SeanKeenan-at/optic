---
title: Using Hapi with Optic
sidebar_label: Hapi
slug: /hapi
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';
import GitHubButton from 'react-github-btn';

Optic is really easy to use with Hapi, you can either use the [`api start` command](#api-start-command) without changing your application, or you can use [`api exec` and use middleware](#middleware-and-api-exec-command) without changing how you interact with your application:

## `api start` Command

Let's say we have a simple Hapi server that we usually develop with on localhost:3005.

### Optic needs to know how to start our API

Our optic.yml file would include our start command (such as `node app.js`).

``` yaml
name: Hapi API
tasks:
    command: node app.js
    inboundUrl: https://localhost:3005
```

### Optic also needs the ability to control what port our API starts on

Optic injects a `$PORT` environment variable for our application to listen on when `api start` is run. Wherever you start your API server, set the port on which it will bind with this environment variable:

#### Before
```
const server = Hapi.server({
    port: 3005,
    host: 'localhost'
});
```

#### After
```
const server = Hapi.server({
    port: process.env.PORT || 3005,
    host: 'localhost'
});
```

## Verifying with `api check start`

The setup tool will guide you through running checks to assure Optic is running successfully with your API project. You should see everything pass at this point. If you don't, it's most likely that you're not starting the API on the `$PORT` Optic provides. The Optic check will also report any other common issues it detects and give you steps and suggestions to resolve them.

Should you need any more help, or want to chat about the process, please reach out to us. You can schedule a [quick chat with the maintainers](https://calendly.com/opticlabs/maintainer-office-hours) or [open an issue on GitHub](https://github.com/opticdev/optic/issues/new?title=API%20Init:%20).

## Run your API through Optic

At this point you should be ready to run `api start` and document your API with Optic! Optic will observe your API traffic locally, and report on the routes and traffic shape it sees in the Optic dashboard. The next step is to start [building your baseline specification](/docs/using/baseline)

## Middleware and `api exec` Command

If you want to use programmatically controlled middleware, or record your endpoint traffic without touching the network using mocks, you can easily include Hapi middleware

### Install the middleware

<Tabs
  defaultValue="yarn"
  values={[
    {label: 'yarn', value: 'yarn'},
    {label: 'npm', value: 'npm'},
  ]}>
  <TabItem value="yarn">

```sh
yarn add @useoptic/hapi-middleware
```

  </TabItem>
  <TabItem value="npm">

```sh
npm install @useoptic/hapi-middleware
```

  </TabItem>
</Tabs>

### Configure the middleware

The middleware accepts a configuration object with the following options:
- `enabled`: `boolean` (defaults to `false`) Programmatically control if capturing data and sending it to Optic
- `uploadUrl`: `string` (defaults to `process.env.OPTIC_LOGGING_URL`) The URL to Optics capture URL, if left blank it will expect `OPTIC_LOGGING_URL` environment variable set by the Optic CLI
- `console`: `boolean` (defaults to `false`) Send to stdout/console for debugging
- `framework`: `string` (defaults to '') Additional information to inform Optic of where it is capturing information

An example of it

```js
const Optic = require('@useoptic/hapi-middleware')

const server = Hapi.server({
  port: 3005,
  host: 'localhost'
})

server.register({
  plugin: Optic,
  options: {
    enabled: true
  }
})
```

### Send traffic via the middleware

To start documenting your API at this point you just need to run `api exec "npm start"`, replacing `npm start` with whatever command you use to start your application.

The command will start a server on an unused port to receive the captures and set `OPTIC_LOGGING_URL` for the middleware to send to the correct location.

Optic will observe your API traffic locally, and report on the routes and traffic shape it sees in the Optic dashboard. The next step is to start [building your baseline specification](/docs/using/baseline)

import {DocContributors} from '../../DocsContributors';

<DocContributors githubUsernames={['acunniffe', 'LouManglass']} />

